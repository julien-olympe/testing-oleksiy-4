// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  createdAt    DateTime @default(now()) @map("created_at")

  projects         Project[]         @relation("ProjectOwner")
  projectPermissions ProjectPermission[]

  @@map("users")
  @@index([email])
}

model Project {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(255)
  ownerId   String   @map("owner_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  owner         User              @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  permissions   ProjectPermission[]
  databases     Database[]
  functions     Function[]

  @@map("projects")
  @@index([ownerId])
}

model ProjectPermission {
  projectId String   @map("project_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  project Project @relation(fields: [projectId], references: [id], onDelete: Restrict)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([projectId, userId])
  @@map("project_permissions")
  @@index([projectId])
  @@index([userId])
}

model Database {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(255)
  projectId String   @map("project_id")
  createdAt DateTime @default(now()) @map("created_at")

  project      Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  properties   DatabaseProperty[]
  instances    DatabaseInstance[]

  @@map("databases")
  @@index([projectId])
  @@unique([projectId, name])
}

model DatabaseProperty {
  id         String   @id @default(uuid())
  databaseId String   @map("database_id")
  name       String   @db.VarChar(255)
  type       String   @db.VarChar(50) // 'string', 'number', 'boolean', 'date'
  createdAt  DateTime @default(now()) @map("created_at")

  database Database              @relation(fields: [databaseId], references: [id], onDelete: Cascade)
  values   DatabaseInstanceValue[]

  @@map("database_properties")
  @@index([databaseId])
  @@unique([databaseId, name])
}

model DatabaseInstance {
  id        String   @id @default(uuid())
  databaseId String  @map("database_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  database Database              @relation(fields: [databaseId], references: [id], onDelete: Cascade)
  values    DatabaseInstanceValue[]

  @@map("database_instances")
  @@index([databaseId])
}

model DatabaseInstanceValue {
  id         String   @id @default(uuid())
  instanceId String   @map("instance_id")
  propertyId String   @map("property_id")
  value      String   @db.Text
  updatedAt  DateTime @updatedAt @map("updated_at")

  instance DatabaseInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  property DatabaseProperty @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("database_instance_values")
  @@index([instanceId])
  @@index([propertyId])
  @@unique([instanceId, propertyId])
}

model Function {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(255)
  projectId String   @map("project_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  project    Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  bricks     Brick[]

  @@map("functions")
  @@index([projectId])
}

model Brick {
  id          String   @id @default(uuid())
  functionId  String   @map("function_id")
  type        String   @db.VarChar(50) // 'ListInstancesByDB', 'GetFirstInstance', 'LogInstanceProps', 'Function'
  positionX   Int      @map("position_x")
  positionY   Int      @map("position_y")
  configuration Json   @db.JsonB
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  function      Function          @relation(fields: [functionId], references: [id], onDelete: Cascade)
  connectionsFrom BrickConnection[] @relation("FromBrick")
  connectionsTo BrickConnection[] @relation("ToBrick")

  @@map("bricks")
  @@index([functionId])
}

model BrickConnection {
  id             String   @id @default(uuid())
  fromBrickId    String   @map("from_brick_id")
  fromOutputName String   @map("from_output_name") @db.VarChar(255)
  toBrickId      String   @map("to_brick_id")
  toInputName    String   @map("to_input_name") @db.VarChar(255)
  createdAt      DateTime @default(now()) @map("created_at")

  fromBrick Brick @relation("FromBrick", fields: [fromBrickId], references: [id], onDelete: Cascade)
  toBrick   Brick @relation("ToBrick", fields: [toBrickId], references: [id], onDelete: Cascade)

  @@map("brick_connections")
  @@index([fromBrickId])
  @@index([toBrickId])
  @@unique([fromBrickId, fromOutputName, toBrickId, toInputName])
}
